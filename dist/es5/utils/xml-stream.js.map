{"version":3,"file":"xml-stream.js","names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","EQUALS_QUOTE","QUOTE","SPACE","pushAttribute","xml","name","value","push","xmlEncode","toString","pushAttributes","attributes","each","undefined","XmlStream","_xml","_stack","_rollbacks","length","docAttributes","parent","tos","open","leaf","Error","attrs","text","node","pop","openNode","writeText","closeNode","stack","cursor","r","splice","closeAll","join","StdDocAttributes","version","encoding","standalone","module","exports"],"sources":["../../../lib/utils/xml-stream.js"],"sourcesContent":["const _ = require('./under-dash');\n\nconst utils = require('./utils');\n\n// constants\nconst OPEN_ANGLE = '<';\nconst CLOSE_ANGLE = '>';\nconst OPEN_ANGLE_SLASH = '</';\nconst CLOSE_SLASH_ANGLE = '/>';\nconst EQUALS_QUOTE = '=\"';\nconst QUOTE = '\"';\nconst SPACE = ' ';\n\nfunction pushAttribute(xml, name, value) {\n  xml.push(SPACE);\n  xml.push(name);\n  xml.push(EQUALS_QUOTE);\n  xml.push(utils.xmlEncode(value.toString()));\n  xml.push(QUOTE);\n}\nfunction pushAttributes(xml, attributes) {\n  if (attributes) {\n    _.each(attributes, (value, name) => {\n      if (value !== undefined) {\n        pushAttribute(xml, name, value);\n      }\n    });\n  }\n}\n\nclass XmlStream {\n  constructor() {\n    this._xml = [];\n    this._stack = [];\n    this._rollbacks = [];\n  }\n\n  get tos() {\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\n  }\n\n  get cursor() {\n    // handy way to track whether anything has been added\n    return this._xml.length;\n  }\n\n  openXml(docAttributes) {\n    const xml = this._xml;\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n    xml.push('<?xml');\n    pushAttributes(xml, docAttributes);\n    xml.push('?>\\n');\n  }\n\n  openNode(name, attributes) {\n    const parent = this.tos;\n    const xml = this._xml;\n    if (parent && this.open) {\n      xml.push(CLOSE_ANGLE);\n    }\n\n    this._stack.push(name);\n\n    // start streaming node\n    xml.push(OPEN_ANGLE);\n    xml.push(name);\n    pushAttributes(xml, attributes);\n    this.leaf = true;\n    this.open = true;\n  }\n\n  addAttribute(name, value) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    if (value !== undefined) {\n      pushAttribute(this._xml, name, value);\n    }\n  }\n\n  addAttributes(attrs) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    pushAttributes(this._xml, attrs);\n  }\n\n  writeText(text) {\n    const xml = this._xml;\n    if (this.open) {\n      xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    xml.push(utils.xmlEncode(text.toString()));\n  }\n\n  writeXml(xml) {\n    if (this.open) {\n      this._xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    this._xml.push(xml);\n  }\n\n  closeNode() {\n    const node = this._stack.pop();\n    const xml = this._xml;\n    if (this.leaf) {\n      xml.push(CLOSE_SLASH_ANGLE);\n    } else {\n      xml.push(OPEN_ANGLE_SLASH);\n      xml.push(node);\n      xml.push(CLOSE_ANGLE);\n    }\n    this.open = false;\n    this.leaf = false;\n  }\n\n  leafNode(name, attributes, text) {\n    this.openNode(name, attributes);\n    if (text !== undefined) {\n      // zeros need to be written\n      this.writeText(text);\n    }\n    this.closeNode();\n  }\n\n  closeAll() {\n    while (this._stack.length) {\n      this.closeNode();\n    }\n  }\n\n  addRollback() {\n    this._rollbacks.push({\n      xml: this._xml.length,\n      stack: this._stack.length,\n      leaf: this.leaf,\n      open: this.open,\n    });\n    return this.cursor;\n  }\n\n  commit() {\n    this._rollbacks.pop();\n  }\n\n  rollback() {\n    const r = this._rollbacks.pop();\n    if (this._xml.length > r.xml) {\n      this._xml.splice(r.xml, this._xml.length - r.xml);\n    }\n    if (this._stack.length > r.stack) {\n      this._stack.splice(r.stack, this._stack.length - r.stack);\n    }\n    this.leaf = r.leaf;\n    this.open = r.open;\n  }\n\n  get xml() {\n    this.closeAll();\n    return this._xml.join('');\n  }\n}\n\nXmlStream.StdDocAttributes = {\n  version: '1.0',\n  encoding: 'UTF-8',\n  standalone: 'yes',\n};\n\nmodule.exports = XmlStream;\n"],"mappings":"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"}