{"version":3,"file":"stuttered-pipe.js","names":["events","require","StutteredPipe","readable","writable","options","bufSize","autoPause","paused","eod","scheduled","on","end","resume","_schedule","clearImmediate","setImmediate","data","read","length","write","EventEmitter","module","exports"],"sources":["../../../lib/utils/stuttered-pipe.js"],"sourcesContent":["const events = require('events');\n\n// =============================================================================\n// StutteredPipe - Used to slow down streaming so GC can get a look in\nclass StutteredPipe extends events.EventEmitter {\n  constructor(readable, writable, options) {\n    super();\n\n    options = options || {};\n\n    this.readable = readable;\n    this.writable = writable;\n    this.bufSize = options.bufSize || 16384;\n    this.autoPause = options.autoPause || false;\n\n    this.paused = false;\n    this.eod = false;\n    this.scheduled = null;\n\n    readable.on('end', () => {\n      this.eod = true;\n      writable.end();\n    });\n\n    // need to have some way to communicate speed of stream\n    // back from the consumer\n    readable.on('readable', () => {\n      if (!this.paused) {\n        this.resume();\n      }\n    });\n    this._schedule();\n  }\n\n  pause() {\n    this.paused = true;\n  }\n\n  resume() {\n    if (!this.eod) {\n      if (this.scheduled !== null) {\n        clearImmediate(this.scheduled);\n      }\n      this._schedule();\n    }\n  }\n\n  _schedule() {\n    this.scheduled = setImmediate(() => {\n      this.scheduled = null;\n      if (!this.eod && !this.paused) {\n        const data = this.readable.read(this.bufSize);\n        if (data && data.length) {\n          this.writable.write(data);\n\n          if (!this.paused && !this.autoPause) {\n            this._schedule();\n          }\n        } else if (!this.paused) {\n          this._schedule();\n        }\n      }\n    });\n  }\n}\n\nmodule.exports = StutteredPipe;\n"],"mappings":";;;;;;;;;;;;;;;AAAA,IAAMA,MAAM,GAAGC,OAAO,CAAC,QAAQ,CAAC;;AAEhC;AACA;AAAA,IACMC,aAAa;EAAA;EAAA;EACjB,uBAAYC,QAAQ,EAAEC,QAAQ,EAAEC,OAAO,EAAE;IAAA;IAAA;IACvC;IAEAA,OAAO,GAAGA,OAAO,IAAI,CAAC,CAAC;IAEvB,MAAKF,QAAQ,GAAGA,QAAQ;IACxB,MAAKC,QAAQ,GAAGA,QAAQ;IACxB,MAAKE,OAAO,GAAGD,OAAO,CAACC,OAAO,IAAI,KAAK;IACvC,MAAKC,SAAS,GAAGF,OAAO,CAACE,SAAS,IAAI,KAAK;IAE3C,MAAKC,MAAM,GAAG,KAAK;IACnB,MAAKC,GAAG,GAAG,KAAK;IAChB,MAAKC,SAAS,GAAG,IAAI;IAErBP,QAAQ,CAACQ,EAAE,CAAC,KAAK,EAAE,YAAM;MACvB,MAAKF,GAAG,GAAG,IAAI;MACfL,QAAQ,CAACQ,GAAG,EAAE;IAChB,CAAC,CAAC;;IAEF;IACA;IACAT,QAAQ,CAACQ,EAAE,CAAC,UAAU,EAAE,YAAM;MAC5B,IAAI,CAAC,MAAKH,MAAM,EAAE;QAChB,MAAKK,MAAM,EAAE;MACf;IACF,CAAC,CAAC;IACF,MAAKC,SAAS,EAAE;IAAC;EACnB;EAAC;IAAA;IAAA,OAED,iBAAQ;MACN,IAAI,CAACN,MAAM,GAAG,IAAI;IACpB;EAAC;IAAA;IAAA,OAED,kBAAS;MACP,IAAI,CAAC,IAAI,CAACC,GAAG,EAAE;QACb,IAAI,IAAI,CAACC,SAAS,KAAK,IAAI,EAAE;UAC3BK,cAAc,CAAC,IAAI,CAACL,SAAS,CAAC;QAChC;QACA,IAAI,CAACI,SAAS,EAAE;MAClB;IACF;EAAC;IAAA;IAAA,OAED,qBAAY;MAAA;MACV,IAAI,CAACJ,SAAS,GAAGM,YAAY,CAAC,YAAM;QAClC,MAAI,CAACN,SAAS,GAAG,IAAI;QACrB,IAAI,CAAC,MAAI,CAACD,GAAG,IAAI,CAAC,MAAI,CAACD,MAAM,EAAE;UAC7B,IAAMS,IAAI,GAAG,MAAI,CAACd,QAAQ,CAACe,IAAI,CAAC,MAAI,CAACZ,OAAO,CAAC;UAC7C,IAAIW,IAAI,IAAIA,IAAI,CAACE,MAAM,EAAE;YACvB,MAAI,CAACf,QAAQ,CAACgB,KAAK,CAACH,IAAI,CAAC;YAEzB,IAAI,CAAC,MAAI,CAACT,MAAM,IAAI,CAAC,MAAI,CAACD,SAAS,EAAE;cACnC,MAAI,CAACO,SAAS,EAAE;YAClB;UACF,CAAC,MAAM,IAAI,CAAC,MAAI,CAACN,MAAM,EAAE;YACvB,MAAI,CAACM,SAAS,EAAE;UAClB;QACF;MACF,CAAC,CAAC;IACJ;EAAC;EAAA;AAAA,EA3DyBd,MAAM,CAACqB,YAAY;AA8D/CC,MAAM,CAACC,OAAO,GAAGrB,aAAa"}