{"version":3,"file":"defined-name-xform.js","names":["BaseXform","require","colCache","DefinedNamesXform","xmlStream","model","openNode","name","localSheetId","writeText","ranges","join","closeNode","node","_parsedName","attributes","_parsedLocalSheetId","_parsedText","text","push","extractRanges","undefined","parseInt","isValidRange","range","decodeEx","err","parsedText","quotesOpened","last","split","forEach","item","quotes","match","length","quotesEven","module","exports"],"sources":["../../../../../lib/xlsx/xform/book/defined-name-xform.js"],"sourcesContent":["const BaseXform = require('../base-xform');\nconst colCache = require('../../../utils/col-cache');\n\nclass DefinedNamesXform extends BaseXform {\n  render(xmlStream, model) {\n    // <definedNames>\n    //   <definedName name=\"name\">name.ranges.join(',')</definedName>\n    //   <definedName name=\"_xlnm.Print_Area\" localSheetId=\"0\">name.ranges.join(',')</definedName>\n    // </definedNames>\n    xmlStream.openNode('definedName', {\n      name: model.name,\n      localSheetId: model.localSheetId,\n    });\n    xmlStream.writeText(model.ranges.join(','));\n    xmlStream.closeNode();\n  }\n\n  parseOpen(node) {\n    switch (node.name) {\n      case 'definedName':\n        this._parsedName = node.attributes.name;\n        this._parsedLocalSheetId = node.attributes.localSheetId;\n        this._parsedText = [];\n        return true;\n      default:\n        return false;\n    }\n  }\n\n  parseText(text) {\n    this._parsedText.push(text);\n  }\n\n  parseClose() {\n    this.model = {\n      name: this._parsedName,\n      ranges: extractRanges(this._parsedText.join('')),\n    };\n    if (this._parsedLocalSheetId !== undefined) {\n      this.model.localSheetId = parseInt(this._parsedLocalSheetId, 10);\n    }\n    return false;\n  }\n}\n\nfunction isValidRange(range) {\n  try {\n    colCache.decodeEx(range);\n    return true;\n  } catch (err) {\n    return false;\n  }\n}\n\nfunction extractRanges(parsedText) {\n  const ranges = [];\n  let quotesOpened = false;\n  let last = '';\n  parsedText.split(',').forEach(item => {\n    if (!item) {\n      return;\n    }\n    const quotes = (item.match(/'/g) || []).length;\n\n    if (!quotes) {\n      if (quotesOpened) {\n        last += `${item},`;\n      } else if (isValidRange(item)) {\n        ranges.push(item);\n      }\n      return;\n    }\n    const quotesEven = quotes % 2 === 0;\n\n    if (!quotesOpened && quotesEven && isValidRange(item)) {\n      ranges.push(item);\n    } else if (quotesOpened && !quotesEven) {\n      quotesOpened = false;\n      if (isValidRange(last + item)) {\n        ranges.push(last + item);\n      }\n      last = '';\n    } else {\n      quotesOpened = true;\n      last += `${item},`;\n    }\n  });\n  return ranges;\n}\n\nmodule.exports = DefinedNamesXform;\n"],"mappings":"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"}