{"version":3,"file":"sheet-comments-writer.js","names":["XmlStream","require","RelType","colCache","CommentXform","VmlShapeXform","SheetCommentsWriter","worksheet","sheetRelsWriter","options","id","count","_worksheet","_workbook","workbook","_sheetRelsWriter","_commentsStream","_openStream","_vmlStream","commentRel","Type","Comments","Target","addRelationship","vmlDrawingRel","VmlDrawing","vmlRelId","commentRefs","push","commentName","vmlDrawing","commentsStream","write","vmlStream","comment","index","commentXform","commentsXmlStream","render","xml","vmlShapeXform","vmlXmlStream","comments","length","startedData","_writeOpen","_addRelationships","_addCommentRefs","forEach","item","refAddress","decodeAddress","ref","_writeComment","_writeClose","end","module","exports"],"sources":["../../../../lib/stream/xlsx/sheet-comments-writer.js"],"sourcesContent":["const XmlStream = require('../../utils/xml-stream');\nconst RelType = require('../../xlsx/rel-type');\nconst colCache = require('../../utils/col-cache');\nconst CommentXform = require('../../xlsx/xform/comment/comment-xform');\nconst VmlShapeXform = require('../../xlsx/xform/comment/vml-shape-xform');\n\nclass SheetCommentsWriter {\n  constructor(worksheet, sheetRelsWriter, options) {\n    // in a workbook, each sheet will have a number\n    this.id = options.id;\n    this.count = 0;\n    this._worksheet = worksheet;\n    this._workbook = options.workbook;\n    this._sheetRelsWriter = sheetRelsWriter;\n  }\n\n  get commentsStream() {\n    if (!this._commentsStream) {\n      // eslint-disable-next-line no-underscore-dangle\n      this._commentsStream = this._workbook._openStream(`/xl/comments${this.id}.xml`);\n    }\n    return this._commentsStream;\n  }\n\n  get vmlStream() {\n    if (!this._vmlStream) {\n      // eslint-disable-next-line no-underscore-dangle\n      this._vmlStream = this._workbook._openStream(`xl/drawings/vmlDrawing${this.id}.vml`);\n    }\n    return this._vmlStream;\n  }\n\n  _addRelationships() {\n    const commentRel = {\n      Type: RelType.Comments,\n      Target: `../comments${this.id}.xml`,\n    };\n    this._sheetRelsWriter.addRelationship(commentRel);\n\n    const vmlDrawingRel = {\n      Type: RelType.VmlDrawing,\n      Target: `../drawings/vmlDrawing${this.id}.vml`,\n    };\n    this.vmlRelId = this._sheetRelsWriter.addRelationship(vmlDrawingRel);\n  }\n\n  _addCommentRefs() {\n    this._workbook.commentRefs.push({\n      commentName: `comments${this.id}`,\n      vmlDrawing: `vmlDrawing${this.id}`,\n    });\n  }\n\n  _writeOpen() {\n    this.commentsStream.write(\n      '<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>' +\n        '<comments xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\">' +\n        '<authors><author>Author</author></authors>' +\n        '<commentList>'\n    );\n    this.vmlStream.write(\n      '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' +\n        '<xml xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\">' +\n        '<o:shapelayout v:ext=\"edit\">' +\n        '<o:idmap v:ext=\"edit\" data=\"1\" />' +\n        '</o:shapelayout>' +\n        '<v:shapetype id=\"_x0000_t202\" coordsize=\"21600,21600\" o:spt=\"202\" path=\"m,l,21600r21600,l21600,xe\">' +\n        '<v:stroke joinstyle=\"miter\" />' +\n        '<v:path gradientshapeok=\"t\" o:connecttype=\"rect\" />' +\n        '</v:shapetype>'\n    );\n  }\n\n  _writeComment(comment, index) {\n    const commentXform = new CommentXform();\n    const commentsXmlStream = new XmlStream();\n    commentXform.render(commentsXmlStream, comment);\n    this.commentsStream.write(commentsXmlStream.xml);\n\n    const vmlShapeXform = new VmlShapeXform();\n    const vmlXmlStream = new XmlStream();\n    vmlShapeXform.render(vmlXmlStream, comment, index);\n    this.vmlStream.write(vmlXmlStream.xml);\n  }\n\n  _writeClose() {\n    this.commentsStream.write('</commentList></comments>');\n    this.vmlStream.write('</xml>');\n  }\n\n  addComments(comments) {\n    if (comments && comments.length) {\n      if (!this.startedData) {\n        this._worksheet.comments = [];\n        this._writeOpen();\n        this._addRelationships();\n        this._addCommentRefs();\n        this.startedData = true;\n      }\n\n      comments.forEach(item => {\n        item.refAddress = colCache.decodeAddress(item.ref);\n      });\n\n      comments.forEach(comment => {\n        this._writeComment(comment, this.count);\n        this.count += 1;\n      });\n    }\n  }\n\n  commit() {\n    if (this.count) {\n      this._writeClose();\n      this.commentsStream.end();\n      this.vmlStream.end();\n    }\n  }\n}\n\nmodule.exports = SheetCommentsWriter;\n"],"mappings":"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"}