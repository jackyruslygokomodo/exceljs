{"version":3,"file":"shared-strings-xform.js","names":["XmlStream","require","BaseXform","SharedStringXform","SharedStringsXform","model","values","count","hash","Object","create","rich","_sharedStringXform","length","index","value","richText","addRichText","addText","undefined","push","xml","sharedStringXform","toXml","xmlStream","_values","openXml","StdDocAttributes","openNode","xmlns","uniqueCount","sx","forEach","sharedString","render","closeNode","node","parser","parseOpen","name","Error","JSON","stringify","text","parseText","parseClose","module","exports"],"sources":["../../../../../lib/xlsx/xform/strings/shared-strings-xform.js"],"sourcesContent":["const XmlStream = require('../../../utils/xml-stream');\nconst BaseXform = require('../base-xform');\nconst SharedStringXform = require('./shared-string-xform');\n\nclass SharedStringsXform extends BaseXform {\n  constructor(model) {\n    super();\n\n    this.model = model || {\n      values: [],\n      count: 0,\n    };\n    this.hash = Object.create(null);\n    this.rich = Object.create(null);\n  }\n\n  get sharedStringXform() {\n    return this._sharedStringXform || (this._sharedStringXform = new SharedStringXform());\n  }\n\n  get values() {\n    return this.model.values;\n  }\n\n  get uniqueCount() {\n    return this.model.values.length;\n  }\n\n  get count() {\n    return this.model.count;\n  }\n\n  getString(index) {\n    return this.model.values[index];\n  }\n\n  add(value) {\n    return value.richText ? this.addRichText(value) : this.addText(value);\n  }\n\n  addText(value) {\n    let index = this.hash[value];\n    if (index === undefined) {\n      index = this.hash[value] = this.model.values.length;\n      this.model.values.push(value);\n    }\n    this.model.count++;\n    return index;\n  }\n\n  addRichText(value) {\n    // TODO: add WeakMap here\n    const xml = this.sharedStringXform.toXml(value);\n    let index = this.rich[xml];\n    if (index === undefined) {\n      index = this.rich[xml] = this.model.values.length;\n      this.model.values.push(value);\n    }\n    this.model.count++;\n    return index;\n  }\n\n  // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n  // <sst xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\" count=\"<%=totalRefs%>\" uniqueCount=\"<%=count%>\">\n  //   <si><t><%=text%></t></si>\n  //   <si><r><rPr></rPr><t></t></r></si>\n  // </sst>\n\n  render(xmlStream, model) {\n    model = model || this._values;\n    xmlStream.openXml(XmlStream.StdDocAttributes);\n\n    xmlStream.openNode('sst', {\n      xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\n      count: model.count,\n      uniqueCount: model.values.length,\n    });\n\n    const sx = this.sharedStringXform;\n    model.values.forEach(sharedString => {\n      sx.render(xmlStream, sharedString);\n    });\n    xmlStream.closeNode();\n  }\n\n  parseOpen(node) {\n    if (this.parser) {\n      this.parser.parseOpen(node);\n      return true;\n    }\n    switch (node.name) {\n      case 'sst':\n        return true;\n      case 'si':\n        this.parser = this.sharedStringXform;\n        this.parser.parseOpen(node);\n        return true;\n      default:\n        throw new Error(`Unexpected xml node in parseOpen: ${JSON.stringify(node)}`);\n    }\n  }\n\n  parseText(text) {\n    if (this.parser) {\n      this.parser.parseText(text);\n    }\n  }\n\n  parseClose(name) {\n    if (this.parser) {\n      if (!this.parser.parseClose(name)) {\n        this.model.values.push(this.parser.model);\n        this.model.count++;\n        this.parser = undefined;\n      }\n      return true;\n    }\n    switch (name) {\n      case 'sst':\n        return false;\n      default:\n        throw new Error(`Unexpected xml node in parseClose: ${name}`);\n    }\n  }\n}\n\nmodule.exports = SharedStringsXform;\n"],"mappings":"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"}